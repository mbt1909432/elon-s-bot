# ElonsBot 产品需求文档 (PRD)

> 将 Nanobot 从 Python CLI 迁移到 Supabase + Next.js Web 应用

---

## 1. 产品定位

### 1.1 愿景

打造一个**云原生的个人 AI 助手平台**，让用户能够：
- 通过 Web 界面和多平台 Bot 与 AI 助手交互
- 拥有持久化的记忆和个性化的服务
- 自动化日常任务和获取智能提醒

### 1.2 目标用户

| 用户类型 | 描述 | 核心需求 |
|---------|------|---------|
| **个人用户** | 希望提升效率的个人 | 多平台访问、记忆功能、任务提醒 |
| **开发者** | 需要编程辅助的技术人员 | 代码生成、调试、API 集成 |
| **研究人员** | 需要信息收集和分析 | 网页搜索、摘要、知识管理 |
| **小团队** | 希望共享 AI 资源 | 多用户、协作功能 (Phase 4) |

### 1.3 核心价值

```
┌─────────────────────────────────────────────────────────┐
│                    核心价值三角                          │
│                                                         │
│                      智能化                             │
│                        △                                │
│                       /│\                               │
│                      / │ \                              │
│                     /  │  \                             │
│                    /   │   \                            │
│              个性化    │    自动化                       │
│                  ───────────────                        │
│                                                         │
│  • 智能化: AI 驱动的对话、搜索、分析                      │
│  • 个性化: 长期记忆、偏好学习、风格适配                    │
│  • 自动化: 定时任务、智能提醒、主动服务                    │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 功能规格

### 2.1 功能架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        ElonsBot 功能架构                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      接入层 (Access Layer)                   │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌───────┐ │   │
│  │  │ Web Chat│ │Telegram │ │ Discord │ │ 飞书    │ │ Slack │ │   │
│  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └───┬───┘ │   │
│  └───────┼───────────┼───────────┼───────────┼───────────┼─────┘   │
│          └───────────┴───────────┴───────────┴───────────┘         │
│                                    │                                │
│  ┌─────────────────────────────────┴───────────────────────────┐   │
│  │                      核心层 (Core Layer)                      │   │
│  │                                                              │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐            │   │
│  │  │  对话引擎   │  │  记忆系统   │  │  工具系统   │            │   │
│  │  │            │  │            │  │            │            │   │
│  │  │ • 多轮对话 │  │ • 长期记忆 │  │ • 网页搜索 │            │   │
│  │  │ • 上下文   │  │ • 事件历史 │  │ • 网页抓取 │            │   │
│  │  │ • 流式响应 │  │ • 语义检索 │  │ • 消息发送 │            │   │
│  │  └────────────┘  └────────────┘  └────────────┘            │   │
│  │                                                              │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐            │   │
│  │  │  任务系统   │  │  提示系统   │  │  会话管理   │            │   │
│  │  │            │  │            │  │            │            │   │
│  │  │ • 定时任务 │  │ • 系统提示 │  │ • 会话存储 │            │   │
│  │  │ • 周期任务 │  │ • 个性化   │  │ • 历史查询 │            │   │
│  │  │ • 任务队列 │  │ • 技能加载 │  │ • 跨渠道   │            │   │
│  │  └────────────┘  └────────────┘  └────────────┘            │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                    │                                │
│  ┌─────────────────────────────────┴───────────────────────────┐   │
│  │                    基础设施层 (Infrastructure)               │   │
│  │                                                              │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │   │
│  │  │Supabase  │  │ LLM API  │  │ 搜索 API │  │ 渠道 API │    │   │
│  │  │ Auth/DB  │  │OpenRouter│  │  Brave   │  │Telegram  │    │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 功能模块详解

#### 2.2.1 用户系统

| 功能 | 描述 | 优先级 |
|------|------|--------|
| **注册/登录** | 邮箱注册、OAuth 登录 (Google/GitHub) | P0 |
| **个人资料** | 显示名称、时区、语言偏好 | P1 |
| **偏好设置** | 沟通风格、响应长度、技术级别 | P2 |
| **安全设置** | 密码修改、会话管理、API Key 管理 | P1 |

**用户配置文件结构**:
```typescript
interface UserProfile {
  id: string;
  displayName: string;
  timezone: string;           // e.g., "Asia/Shanghai"
  language: 'zh-CN' | 'en-US' | 'ja-JP';
  preferences: {
    communicationStyle: 'casual' | 'professional' | 'technical';
    responseLength: 'brief' | 'detailed' | 'adaptive';
    technicalLevel: 'beginner' | 'intermediate' | 'expert';
  };
  createdAt: Date;
  updatedAt: Date;
}
```

#### 2.2.2 对话系统

| 功能 | 描述 | 优先级 |
|------|------|--------|
| **多轮对话** | 保持上下文的多轮交互 | P0 |
| **流式响应** | 实时显示 AI 响应 | P0 |
| **Markdown 渲染** | 支持代码块、表格等 | P0 |
| **工具调用展示** | 显示工具执行过程 | P1 |
| **对话历史** | 保存和检索历史对话 | P0 |
| **对话搜索** | 搜索历史对话内容 | P2 |
| **对话导出** | 导出对话为 Markdown/PDF | P3 |

**对话界面交互**:
```
用户输入 → AI 思考 (显示 loading) → 工具调用 (可选显示) → 流式输出响应
```

#### 2.2.3 记忆系统

| 功能 | 描述 | 优先级 |
|------|------|--------|
| **自动记忆** | AI 自动提取并存储重要信息 | P1 |
| **手动记忆** | 用户手动添加记忆条目 | P0 |
| **记忆分类** | 按类别组织记忆 (偏好、事实、关系) | P0 |
| **记忆搜索** | 搜索记忆内容 | P1 |
| **记忆编辑** | 编辑和删除记忆 | P0 |
| **语义搜索** | 基于语义相似度搜索 (Phase 4) | P3 |

**记忆分类**:
```
├── preferences/     # 用户偏好
│   ├── 饮食偏好
│   ├── 工作时间
│   └── 沟通风格
├── facts/           # 事实信息
│   ├── 生日
│   ├── 职位
│   └── 项目信息
├── relationships/   # 关系信息
│   ├── 同事
│   ├── 家人
│   └── 朋友
└── context/         # 上下文信息
    ├── 当前目标
    ├── 进行中项目
    └── 注意事项
```

#### 2.2.4 工具系统

**内置工具**:

| 工具 | 功能 | 输入 | 输出 | 优先级 |
|------|------|------|------|--------|
| `web_search` | 网页搜索 | 查询词 | 搜索结果列表 | P0 |
| `web_fetch` | 网页抓取 | URL | 页面内容 | P0 |
| `memory_save` | 保存记忆 | 分类/键/值 | 确认 | P1 |
| `memory_recall` | 回忆信息 | 查询词 | 相关记忆 | P1 |
| `message_send` | 发送消息 | 渠道/内容 | 确认 | P1 |
| `task_create` | 创建任务 | 时间/内容 | 任务ID | P2 |
| `file_read` | 读取文件 | 路径 | 内容 | P3 |
| `file_write` | 写入文件 | 路径/内容 | 确认 | P3 |

**工具执行流程**:
```
1. AI 决定使用工具
2. 系统验证权限和安全限制
3. 执行工具调用
4. 返回结果给 AI
5. AI 基于结果继续响应
```

#### 2.2.5 任务系统

| 功能 | 描述 | 优先级 |
|------|------|--------|
| **定时提醒** | 在指定时间发送提醒 | P1 |
| **周期任务** | 每日/每周/自定义周期 | P1 |
| **任务管理** | 创建/查看/删除任务 | P1 |
| **任务状态** | 活跃/暂停/完成 | P2 |
| **智能调度** | 自然语言创建任务 | P2 |

**任务创建方式**:
```
# 通过 Web UI
[创建任务] → 填写表单 → 保存

# 通过对话
用户: "每天早上9点提醒我查看邮件"
AI: 好的，我已经创建了每日提醒任务。

# 通过 API
POST /api/cron
{
  "name": "每日邮件检查",
  "message": "请检查邮件并汇报重要事项",
  "cronExpression": "0 9 * * *",
  "channel": "web"
}
```

#### 2.2.6 渠道系统

| 渠道 | 接入方式 | 功能支持 | 优先级 |
|------|----------|----------|--------|
| **Web** | 原生 | 完整功能 | P0 |
| **Telegram** | Webhook | 对话、工具、任务 | P1 |
| **Discord** | Interactions | 对话、工具、任务 | P2 |
| **飞书** | WebSocket | 对话、工具 | P3 |
| **Slack** | Socket Mode | 对话、工具 | P3 |

**渠道配置流程**:
```
1. 用户进入设置 → 渠道配置
2. 选择要启用的渠道
3. 输入渠道凭证 (Token/Secret)
4. 验证连接
5. 配置访问白名单 (可选)
6. 保存并启用
```

---

## 3. 用户界面设计

### 3.1 信息架构

```
首页 (Chat)
├── 侧边栏
│   ├── 新建对话
│   ├── 对话列表 (按日期分组)
│   │   ├── 今天
│   │   ├── 昨天
│   │   └── 更早
│   └── 底部导航
│       ├── 设置
│       ├── 记忆
│       └── 任务
│
├── 主内容区
│   ├── 对话标题栏
│   ├── 消息列表
│   └── 输入区
│
└── 浮动面板 (可选)
    ├── 记忆面板
    └── 任务面板

设置
├── 个人资料
├── AI 提供商
├── 渠道配置
├── Agent 设置
└── 安全设置

记忆管理
├── 记忆搜索
├── 分类筛选
├── 记忆列表
└── 记忆编辑器

任务管理
├── 任务列表
├── 任务创建
└── 执行历史
```

### 3.2 页面流程

#### 3.2.1 用户认证流程

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   访问应用    │────▶│  已登录？     │────▶│   首页       │
└──────────────┘     └──────┬───────┘     └──────────────┘
                            │ 否
                            ▼
                     ┌──────────────┐
                     │   登录页面    │
                     └──────┬───────┘
                            │
              ┌─────────────┼─────────────┐
              ▼             ▼             ▼
       ┌──────────┐  ┌──────────┐  ┌──────────┐
       │ 邮箱登录  │  │ Google   │  │ GitHub   │
       └────┬─────┘  └────┬─────┘  └────┬─────┘
            │              │              │
            └──────────────┼──────────────┘
                           ▼
                    ┌──────────────┐
                    │  验证成功     │
                    └──────┬───────┘
                           │
                           ▼
                    ┌──────────────┐
                    │   首页       │
                    └──────────────┘
```

#### 3.2.2 对话流程

```
┌─────────────────────────────────────────────────────────┐
│                      对话流程                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. 用户输入消息                                         │
│     │                                                   │
│     ▼                                                   │
│  2. 发送到 /api/chat                                    │
│     │                                                   │
│     ▼                                                   │
│  3. 系统构建上下文 (历史 + 记忆 + 系统提示)              │
│     │                                                   │
│     ▼                                                   │
│  4. 调用 LLM API (流式)                                 │
│     │                                                   │
│     ├──▶ 需要工具？                                     │
│     │    │                                              │
│     │    ├── 是 ─▶ 执行工具 ─▶ 返回结果 ─▶ 继续调用 LLM │
│     │    │                                              │
│     │    └── 否 ─▶ 直接返回响应                         │
│     │                                                   │
│     ▼                                                   │
│  5. 流式显示响应                                         │
│     │                                                   │
│     ▼                                                   │
│  6. 保存对话历史                                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.3 响应式设计

| 断点 | 布局 | 侧边栏 |
|------|------|--------|
| Mobile (< 768px) | 单栏 | 抽屉式 |
| Tablet (768px - 1024px) | 双栏 | 可折叠 |
| Desktop (> 1024px) | 双栏 | 始终显示 |

### 3.4 主题

- **Light Mode**: 浅色背景，深色文字
- **Dark Mode**: 深色背景，浅色文字
- **自动跟随**: 跟随系统设置

---

## 4. 技术约束

### 4.1 平台约束

| 约束 | 描述 | 解决方案 |
|------|------|---------|
| **Vercel 函数超时** | Hobby 计划 10s, Pro 60s | 流式响应, 长任务使用后台队列 |
| **WebSocket 连接** | Serverless 环境不稳定 | Supabase Realtime 作为替代 |
| **Cron 频率** | Vercel Cron 最小间隔 1 分钟 | 足够满足大多数需求 |

### 4.2 安全约束

| 风险 | 缓解措施 |
|------|---------|
| **API Key 泄露** | 加密存储, RLS 策略 |
| **工具滥用** | 白名单, 频率限制 |
| **XSS 攻击** | Markdown 消毒, CSP |
| **数据泄露** | RLS, 最小权限原则 |

### 4.3 性能指标

| 指标 | 目标 |
|------|------|
| **首屏加载** | < 2s |
| **消息发送延迟** | < 200ms |
| **流式首字节** | < 1s |
| **工具执行** | < 5s (超时可配置) |

---

## 5. 发布计划

### 5.1 版本规划

```
v0.1.0 (MVP)
├── 用户认证
├── Web 聊天
├── 基础工具 (web_search, web_fetch)
├── 记忆系统
└── 会话管理

v0.2.0 (多平台)
├── Telegram Bot
├── Discord Bot
└── 渠道配置

v0.3.0 (任务系统)
├── 定时任务
├── 任务管理 UI
└── 事件历史

v0.4.0 (增强功能)
├── 多模型支持
├── 语义搜索
├── 技能系统
└── 使用统计

v1.0.0 (正式版)
├── 稳定性优化
├── 性能优化
├── 文档完善
└── 错误处理
```

### 5.2 上线检查清单

**功能检查**:
- [ ] 所有核心功能可用
- [ ] 错误处理完善
- [ ] 边界情况测试
- [ ] 多浏览器兼容

**安全检查**:
- [ ] RLS 策略正确配置
- [ ] API Key 加密存储
- [ ] 输入验证
- [ ] Rate Limiting

**性能检查**:
- [ ] 首屏加载优化
- [ ] 图片/资源压缩
- [ ] 数据库索引
- [ ] 缓存策略

**运维检查**:
- [ ] 错误监控 (Sentry)
- [ ] 日志收集
- [ ] 告警配置
- [ ] 备份策略

---

## 6. 成功指标

### 6.1 用户指标

| 指标 | 目标 (3 个月) | 衡量方式 |
|------|--------------|---------|
| **注册用户** | 1,000+ | 数据库统计 |
| **日活用户** | 100+ | DAU 统计 |
| **消息量** | 10,000+ | 消息表统计 |
| **留存率** | 30%+ | 周留存 |

### 6.2 功能指标

| 指标 | 目标 | 衡量方式 |
|------|------|---------|
| **对话满意度** | > 80% | 反馈统计 |
| **工具成功率** | > 95% | 执行日志 |
| **响应时间** | < 3s | 监控 |
| **可用性** | > 99% | Uptime 监控 |

---

## 7. 风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| **LLM API 限制** | 高 | 中 | 多提供商支持, 本地缓存 |
| **Vercel 限制** | 中 | 低 | Pro 计划, 自托管备选 |
| **安全漏洞** | 高 | 低 | 安全审计, 渗透测试 |
| **用户增长过快** | 中 | 低 | 弹性架构, 成本控制 |

---

*文档版本: 1.0*
*最后更新: 2026-02-17*
*负责人: ElonsBot Team*
